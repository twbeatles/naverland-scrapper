# 네이버 부동산 스크래핑 구현 점검 보고서

- 점검일: 2026-02-27
- 기준 문서: `README.md`, `claude.md`
- 점검 범위: `src/core`(crawler/parser/cache/database), `src/ui`(crawler_tab/batch dialog), `tests`
- 현재 테스트 상태: `pytest -q` 54 passed (업데이트: 2026-02-28)

## 후속 반영 결과 (2026-02-28)

- 본 문서의 핵심 이슈 1~9를 모두 코드/테스트/문서에 반영 완료.
- 구현 요약:
  - 캐시 저장을 원본(raw items) 중심으로 전환하고 캐시 히트 시 현재 필터로 재평가.
  - 월세 필터를 `보증금(min/max)` + `월세(min/max)` 동시 만족 정책으로 분리.
  - 차단/방어 페이지 시그널 감지 시 즉시 실패 처리(정상 0건 오인 방지).
  - 내부 스크롤 컨테이너 탐지 우선, 실패 시 window 스크롤 폴백.
  - URL 숫자 추출 기준 강화(무문맥 숫자 과추출 완화).
  - URL 배치 등록에서 이름 미확인(`단지_...`) 항목 기본 체크 해제.
  - `shutdown_crawl()` 실패 시 앱 종료 중단 및 DB close 차단.
  - `retry_on_error` 설정 실동작 연결(OFF 시 재시도 0), `base_delay` 반영.
  - 고급 필터를 CrawlerTab에 실구현(버튼/배지/테이블+카드뷰 통합).
- 문서 정합성 반영:
  - `README.md`, `update_history.md`, `implementation_audit.md`, `claude.md`, `gemini.md` 업데이트.
- 빌드 설정 점검:
  - `naverland-scrapper.spec` 점검 결과, 본 배치 기준 추가 hidden import/옵션 수정은 불필요.

## 요약
현 구현은 기능 폭이 넓고 기본 회귀 테스트도 통과하고 있으나, 실제 수집 정확도/운영 신뢰성에 영향을 줄 수 있는 구조적 이슈가 몇 가지 있습니다. 특히 **캐시-필터 결합 방식**, **월세 필터 판정값**, **차단/부분수집 탐지 부재**는 우선 개선이 필요합니다.

## 핵심 이슈

### 1) [높음] 캐시에 "필터 통과 결과"만 저장되어 필터 변경 시 오탐/누락 발생
- 근거:
  - `src/core/crawler.py:634-637` (필터 통과 항목만 `items_to_cache`에 추가)
  - `src/core/crawler.py:564-567` (`items_to_cache`를 캐시에 저장)
  - `src/core/cache.py:26-28` (캐시 키가 `complex_id + trade_type`만 사용)
- 영향:
  - 1회 크롤링에서 강한 필터를 걸고 실행한 뒤, 같은 단지/거래유형에서 필터를 완화해도 캐시 히트 시 과거 축약 결과만 보여 **데이터 누락** 가능.
- 권장:
  - 캐시에는 "파싱 원본(raw items)" 저장 후 조회 시 필터 적용.
  - 또는 캐시 키에 필터 시그니처(면적/가격 범위)를 포함.

### 2) [높음] 월세 가격 필터가 월세가 아닌 보증금 기준으로 동작
- 근거:
  - `src/ui/widgets/crawler_tab.py:725` (`"월세"` 필터 범위 전달)
  - `src/core/crawler.py:663-665` (매매 외 모든 유형에서 `보증금`으로 가격 비교)
- 영향:
  - UI에서 월세 범위를 설정해도 실제로는 보증금으로 필터링되어 결과가 사용자 기대와 다르게 나옴.
- 권장:
  - `ttype == "월세"`일 때 `월세` 필드 기준 필터링하도록 분기.
  - 필요 시 `보증금`과 `월세`를 각각 필터로 분리.

### 3) [높음] 차단/봇 방어 페이지를 정상 0건으로 오인할 수 있음
- 근거:
  - `src/core/crawler.py:536-543` (대기 타임아웃 후 계속 진행)
  - `src/core/crawler.py:621-622` (파싱 대상 없으면 경고만 남기고 0건 반환)
- 영향:
  - 네이버 차단/인증/레이아웃 급변 상황에서 "정상 빈 결과"처럼 처리되어 수집 신뢰도 저하.
- 권장:
  - `driver.page_source`/`title`에서 차단 시그널(캡차, 접근 제한 문구) 검사 후 재시도/실패 코드로 분기.

### 4) [중간] 스크롤 대상이 `window` 고정이라 내부 스크롤 컨테이너 변경 시 부분 수집 위험
- 근거:
  - `src/core/crawler.py:607` (`window.scrollTo(...)`만 사용)
- 영향:
  - 리스트가 내부 컨테이너 스크롤로 동작하면 전체 매물을 못 읽고 일부만 파싱 가능.
- 권장:
  - 스크롤 가능한 리스트 컨테이너를 탐지해 해당 엘리먼트 `scrollTop` 기반으로 스크롤.
  - 스크롤 종료 조건을 "아이템 수" 외에 "매물ID 신규 유입 없음"으로 보강.

### 5) [중간] URL 일괄 등록에서 숫자 추출이 과도해 잘못된 단지 ID가 유입될 수 있음
- 근거:
  - `src/core/parser.py:28` (`\b(\d{5,10})\b` 광범위 추출)
  - `src/core/parser.py:56-60` (텍스트 내 숫자를 단지 ID로 직접 채택)
  - `src/ui/dialogs/batch.py:95` (추출 결과 기본 체크 ON)
- 영향:
  - 기사 ID/임의 숫자가 단지 ID로 유입되어 이후 크롤링 실패/잡음 증가.
- 권장:
  - 숫자 단독 추출 조건을 강화(접두어/문맥 기반).
  - API 검증 실패(예: `단지_12345`) 항목은 기본 체크 해제.

### 6) [중간] 종료 타임아웃 시 크롤링 스레드 생존 상태로 DB close 진행 가능
- 근거:
  - `src/ui/app.py:1078-1086` (`shutdown_crawl` 실패 시에도 종료 진행)
- 영향:
  - 드물게 스레드가 DB 작업 중이면 종료 레이스/오류 로그 발생 가능.
- 권장:
  - 타임아웃 시 DB close 지연 또는 강제 중단 전략 명확화.
  - 최소한 "강제 종료 모드"를 사용자에게 선택하게 하거나 안전 종료 재시도.

### 7) [중간] `RetryHandler.base_delay` 설정값이 실질적으로 반영되지 않음
- 근거:
  - `src/utils/retry_handler.py:8-10` (`base_delay` 보관)
  - `src/utils/error_handler.py:39-44` (`base_delay = 2.0` 상수 사용)
  - `src/core/parser.py:31` (`base_delay=1.0` 지정했지만 효과 없음)
- 영향:
  - 재시도 튜닝이 설정/호출부 의도대로 동작하지 않음.
- 권장:
  - `get_wait_time`에 `base_delay` 인자 전달하거나 `RetryHandler`에서 직접 지수백오프 계산.

### 8) [낮음] 설정 키 `retry_on_error`가 선언되지만 실제 소비되지 않음
- 근거:
  - `src/core/managers.py:32` (`retry_on_error` 정의)
  - 코드 사용처 없음(`rg` 기준)
- 영향:
  - 설정-동작 불일치로 운영 혼선.
- 권장:
  - 실제 로직 연결 또는 설정 항목 제거.

### 9) [낮음] README의 "고급 필터링(층수/키워드 포함·제외)"과 현재 UI 경로 불일치
- 근거:
  - `README.md:19` (고급 필터링 지원 명시)
  - `src/ui/app.py:791-803` (앱 레벨 고급 필터 경로 deprecated 처리)
- 영향:
  - 사용자 문서 기대치와 현재 접근 가능한 기능 간 괴리.
- 권장:
  - CrawlerTab에서 고급 필터 UI/적용 경로를 명시적으로 제공하거나 README 문구 정정.

## 테스트 관점 추가 필요 항목
- 월세 필터가 `월세` 값 기준으로 동작하는지 검증 테스트 추가.
- 캐시 사용 상태에서 필터 완화/강화 시 결과 일관성 테스트 추가.
- URL 일괄 등록에서 잘못된 숫자(예: articleId) 유입 방지 테스트 추가.
- 차단 페이지/빈 페이지를 구분하는 실패 처리 테스트(모의 HTML fixture) 추가.

## 우선순위 제안 (실행 순서)
1. 캐시 구조 수정(raw 저장 또는 필터 시그니처 키)
2. 월세 필터 로직 수정
3. 차단 페이지/부분 수집 감지 로직 도입
4. 재시도 `base_delay` 반영 및 `retry_on_error` 정리
5. 문서(README)와 실제 기능 경로 정합성 맞춤
